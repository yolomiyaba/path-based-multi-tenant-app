name: Aurora DB Control

on:
  workflow_dispatch:
    inputs:
      action:
        description: '実行するアクション'
        required: true
        type: choice
        options:
          - start
          - stop
          - status

env:
  AWS_REGION: 'ap-northeast-1'
  CLUSTER_IDENTIFIER: 'leadxaid-dev'

permissions:
  id-token: write
  contents: read

jobs:
  control:
    name: ${{ inputs.action }} Aurora Cluster
    runs-on: ubuntu-latest

    steps:
      - name: Configure AWS credentials
        uses: aws-actions/configure-aws-credentials@v4
        with:
          role-to-assume: ${{ secrets.AWS_ROLE_ARN }}
          aws-region: ${{ env.AWS_REGION }}

      - name: Get cluster status
        id: status
        run: |
          STATUS=$(aws rds describe-db-clusters \
            --db-cluster-identifier ${{ env.CLUSTER_IDENTIFIER }} \
            --query 'DBClusters[0].Status' \
            --output text)
          echo "status=$STATUS" >> $GITHUB_OUTPUT
          echo "Current status: $STATUS"

      - name: Start cluster
        if: inputs.action == 'start'
        run: |
          if [ "${{ steps.status.outputs.status }}" = "stopped" ]; then
            echo "Starting cluster..."
            aws rds start-db-cluster --db-cluster-identifier ${{ env.CLUSTER_IDENTIFIER }}
            echo "Waiting for cluster to become available..."
            aws rds wait db-cluster-available --db-cluster-identifier ${{ env.CLUSTER_IDENTIFIER }}
            echo "Cluster is now available!"
          else
            echo "Cluster is already running (status: ${{ steps.status.outputs.status }})"
          fi

      - name: Stop cluster
        if: inputs.action == 'stop'
        run: |
          if [ "${{ steps.status.outputs.status }}" = "available" ]; then
            echo "Stopping cluster..."
            aws rds stop-db-cluster --db-cluster-identifier ${{ env.CLUSTER_IDENTIFIER }}
            echo "Cluster stop initiated. It will take a few minutes to fully stop."
          else
            echo "Cluster is not in a state that can be stopped (status: ${{ steps.status.outputs.status }})"
          fi

      - name: Show final status
        run: |
          STATUS=$(aws rds describe-db-clusters \
            --db-cluster-identifier ${{ env.CLUSTER_IDENTIFIER }} \
            --query 'DBClusters[0].Status' \
            --output text)
          echo "Final status: $STATUS"
